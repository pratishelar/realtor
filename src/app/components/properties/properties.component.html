
    <div class="container-fluid py-4">
      <!-- Mobile Filter Toggle Button -->
      <div class="d-lg-none mb-3">
        <button class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2" (click)="toggleFilters()">
          <span>{{ showFilters ? '‚úï' : '‚ò∞' }}</span>
          <span>{{ showFilters ? 'Hide Filters' : 'Show Filters' }}</span>
        </button>
      </div>
      
      <div class="row g-4">
        <div class="col-12 col-lg-3" [class.d-none]="!showFilters" [class.d-lg-block]="true">
          <div class="sidebar-filters card p-4">

            <!-- City -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">City</label>
              <select [(ngModel)]="selectedCityFilter" (change)="onCityFilterChange()" class="form-select">
                <option value="">All Cities</option>
                <option *ngFor="let city of getAvailableCities()" [value]="city">{{ city }}</option>
              </select>
            </div>

            <!-- Search Bar -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Search</label>
              <div class="search-autocomplete position-relative">
                <input
                  type="text"
                  placeholder="Search by location..."
                  [(ngModel)]="searchQuery"
                  (input)="onSearchInput()"
                  (focus)="onSearchFocus()"
                  (blur)="onSearchBlur()"
                  class="form-control"
                />

                <div class="search-suggestions list-group" *ngIf="showLocationSuggestions && locationSuggestions.length > 0">
                  <button
                    type="button"
                    class="list-group-item list-group-item-action"
                    *ngFor="let suggestion of locationSuggestions"
                    (mousedown)="$event.preventDefault()"
                    (click)="selectLocationSuggestion(suggestion)"
                  >
                    {{ suggestion }}
                  </button>
                </div>

                <div class="selected-search-badge mt-2" *ngIf="selectedSearchLocations.length > 0">
                  <span
                    class="badge text-bg-light border d-inline-flex align-items-center gap-2 py-2 px-3 me-2 mb-2"
                    *ngFor="let selectedLocation of selectedSearchLocations"
                  >
                    {{ selectedLocation }}
                    <button
                      type="button"
                      class="badge-clear-btn"
                      (click)="removeSelectedLocation(selectedLocation, $event)"
                      aria-label="Remove selected location"
                    >
                      √ó
                    </button>
                  </span>
                </div>
              </div>
            </div>

            <!-- Category (moved to top) -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Category</label>
              <div class="property-type-chip-wrap">
                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedCategory === 'residential'"
                  [attr.aria-pressed]="selectedCategory === 'residential'"
                  (click)="selectedCategory = 'residential'; onCategoryChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Residential</span>
                </button>

                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedCategory === 'commercial'"
                  [attr.aria-pressed]="selectedCategory === 'commercial'"
                  (click)="selectedCategory = 'commercial'; onCategoryChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Commercial</span>
                </button>
              </div>
            </div>

            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Buy / Rent</label>
              <div class="property-type-chip-wrap">
                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedListingIntent === 'buy'"
                  [attr.aria-pressed]="selectedListingIntent === 'buy'"
                  (click)="selectedListingIntent = 'buy'; onListingIntentChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Buy</span>
                </button>

                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedListingIntent === 'rent'"
                  [attr.aria-pressed]="selectedListingIntent === 'rent'"
                  (click)="selectedListingIntent = 'rent'; onListingIntentChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Rent</span>
                </button>
              </div>
            </div>

            <!-- Property Type (moved to top) -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Property Type</label>
              <div class="property-type-chip-wrap">
                <button
                  type="button"
                  class="property-type-chip"
                  *ngFor="let type of getAvailablePropertyTypes()"
                  [class.active]="isPropertyTypeSelected(type.key)"
                  [attr.aria-pressed]="isPropertyTypeSelected(type.key)"
                  (click)="togglePropertyType(type.key)"
                >
                  <span class="chip-check">‚úì</span>
                  <span>{{ type.label }}</span>
                </button>
              </div>
            </div>

            <!-- Possession Status -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Possession Status</label>
              <div class="property-type-chip-wrap">
                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedResale"
                  [attr.aria-pressed]="selectedResale"
                  (click)="selectedResale = !selectedResale; onPossessionFilterChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Resale</span>
                </button>

                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedReadyToMove"
                  [attr.aria-pressed]="selectedReadyToMove"
                  (click)="selectedReadyToMove = !selectedReadyToMove; onPossessionFilterChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Ready to Move</span>
                </button>

                <button
                  type="button"
                  class="property-type-chip"
                  [class.active]="selectedUnderConstruction"
                  [attr.aria-pressed]="selectedUnderConstruction"
                  (click)="selectedUnderConstruction = !selectedUnderConstruction; onPossessionFilterChange()"
                >
                  <span class="chip-check">‚úì</span>
                  <span>Under Construction</span>
                </button>
              </div>
            </div>

            <!-- Price Range -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Price Range</label>
              <div class="mb-3">
                <label class="form-label small">Min Price: ‚Çπ{{ minPrice | number }}</label>
                <input
                  type="range"
                  [(ngModel)]="minPrice"
                  (input)="onMinPriceChange()"
                  class="form-range"
                  [min]="priceFloor"
                  [max]="priceCeiling"
                  step="10000"
                />
              </div>
              <div class="mb-3">
                <label class="form-label small">Max Price: ‚Çπ{{ maxPrice | number }}</label>
                <input
                  type="range"
                  [(ngModel)]="maxPrice"
                  (input)="onMaxPriceChange()"
                  class="form-range"
                  [min]="priceFloor"
                  [max]="priceCeiling"
                  step="10000"
                />
              </div>
              <div class="text-muted small">‚Çπ{{ minPrice | number }} - ‚Çπ{{ maxPrice | number }}</div>
            </div>

            <!-- Bedrooms -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Bedrooms</label>
              <select [(ngModel)]="selectedBedrooms" (change)="applyFilters()" class="form-select">
                <option [ngValue]="null">All</option>
                <option [ngValue]="1">1</option>
                <option [ngValue]="2">2</option>
                <option [ngValue]="3">3</option>
                <option [ngValue]="4">4</option>
                <option [ngValue]="5">5+</option>
              </select>
            </div>

            <!-- Bathrooms -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Bathrooms</label>
              <select [(ngModel)]="selectedBathrooms" (change)="applyFilters()" class="form-select">
                <option [ngValue]="null">All</option>
                <option [ngValue]="1">1</option>
                <option [ngValue]="2">2</option>
                <option [ngValue]="3">3</option>
                <option [ngValue]="4">4+</option>
              </select>
            </div>


            <!-- Area/Size -->
            <div class="filter-section mb-4">
              <label class="form-label fw-bold">Minimum Area (sqft)</label>
              <input
                type="number"
                [(ngModel)]="minArea"
                (change)="applyFilters()"
                class="form-control"
                placeholder="Min sqft"
              />
            </div>

            <!-- Reset Filters -->
            <button (click)="resetFilters()" class="btn btn-outline-secondary w-100">Reset All Filters</button>
          </div>
        </div>

        <div class="col-12 col-lg-9">
          <div class="listings-toolbar d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
            <div>
              <h2 class="listings-count mb-1">Showing {{ filteredProperties.length | number }} Listings</h2>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-2 gap-md-3">
              <select [(ngModel)]="sortBy" (change)="applyFilters()" class="toolbar-select form-select">
                <option value="newest">Sort By</option>
                <option value="price-low">Price: Low to High</option>
                <option value="price-high">Price: High to Low</option>
                <option value="size">Size: Large to Small</option>
              </select>
            </div>
          </div>

          <div *ngIf="loading" class="text-center py-5">
            <div class="spinner-border" role="status">
              <span class="visually-hidden">Loading properties...</span>
            </div>
          </div>

          <div *ngIf="!loading && loadError" class="alert alert-warning d-flex justify-content-between align-items-center" role="alert">
            <span>{{ loadError }}</span>
            <button class="btn btn-sm btn-outline-dark" (click)="loadProperties()">Retry</button>
          </div>

          <div *ngIf="!loading && !loadError && filteredProperties.length === 0" class="text-center py-5">
            <p class="text-muted mb-3">No properties match your filters.</p>
            <button (click)="resetFilters()" class="btn btn-outline-secondary">Clear Filters</button>
          </div>

          <div class="row g-3">
            <div *ngFor="let property of visibleProperties; trackBy: trackByPropertyId" class="col-12">
              <div class="property-listing-card card overflow-hidden border-0 shadow-sm" (click)="openPropertyDetails(property.id)" (keypress)="onCardKeypress($event, property.id)" tabindex="0" role="button">
                <div class="row g-0">
                  <!-- Property Image -->
                  <div class="col-12 col-lg-5">
                    <div class="property-image-container position-relative">
                      <img
                        *ngIf="property.mainImage || (property.images && property.images.length > 0)"
                        [src]="getPrimaryImage(property)"
                        [alt]="property.name || property.title"
                        loading="lazy"
                        decoding="async"
                        (error)="handleImageError($event)"
                        class="property-main-image"
                      />
                      <div *ngIf="!property.images || property.images.length === 0" class="no-image-placeholder d-flex align-items-center justify-content-center">
                        <span class="text-muted">No Image Available</span>
                      </div>
                      <div class="image-count-badge position-absolute top-0 start-0 m-3 bg-dark bg-opacity-75 text-white px-2 py-1 rounded">
                        <i class="bi bi-images"></i> {{ property.images.length || 0 }}
                      </div>
                      <div class="listing-intent-badge position-absolute bottom-0 start-0 m-3 px-3 py-1 rounded-pill fw-semibold">
                        {{ getListingIntentLabel(property) }}
                      </div>
                      <button class="favorite-btn position-absolute top-0 end-0 m-3 btn btn-light rounded-circle p-2" title="Add to favorites">
                        ‚ô°
                      </button>
                    </div>
                  </div>
                  
                  <!-- Property Details -->
                  <div class="col-12 col-lg-7">
                    <div class="property-content p-3">
                      <!-- Title and Location -->
                      <div class="mb-3">
                        <h3 class="property-listing-title mb-2">{{ property.name || property.title }}</h3>
                        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                          <p class="property-subtitle text-muted mb-0">
                            {{ getPrimaryConfig(property) }} for {{ getListingIntentLabel(property) }} in {{ property.city || property.location }}
                          </p>
                     
                        </div>
                      </div>
                      
                      <!-- Price -->
                      <div class="property-price mb-3">
                        <h2 class="mb-0 fw-bold">‚Çπ{{ getDisplayPrice(property) | number }}</h2>
                      </div>
                      
                      <!-- Features Grid -->
                      <div class="property-features-grid row g-3 mb-3">
                        <div class="col-6 col-md-4">
                          <div class="feature-item d-flex align-items-center gap-2">
                            <span class="feature-icon">üõèÔ∏è</span>
                            <span class="feature-text">{{ getPrimaryConfig(property) }} + {{ property.bathrooms }} Bath</span>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="feature-item d-flex align-items-center gap-2">
                            <span class="feature-icon">üìê</span>
                            <span class="feature-text">{{ getDisplayArea(property) | number }} Sq.Ft</span>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="feature-item d-flex align-items-center gap-2">
                            <span class="feature-icon">üè¢</span>
                            <span class="feature-text">{{ getDisplayStatus(property) }}</span>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="feature-item d-flex align-items-center gap-2">
                            <span class="feature-icon">ü™ë</span>
                            <span class="feature-text">{{ property.numberOfUnits || 0 }} Units</span>
                          </div>
                        </div>
                        <div class="col-6 col-md-4">
                          <div class="feature-item d-flex align-items-center gap-2">
                            <span class="feature-icon">üÖøÔ∏è</span>
                            <span class="feature-text">RERA: {{ property.reraDetails.reraStatus || 'N/A' }}</span>
                          </div>
                        </div>
                      </div>
                      
                      <!-- Description -->
                      <div class="property-description mb-3">
                        <p class="text-muted mb-0 small">
                          {{ (property.description || '') | slice: 0: 180 }}{{ (property.description || '').length > 180 ? '...' : '' }}
                          <a href="#" class="text-primary text-decoration-none" (click)="$event.preventDefault(); $event.stopPropagation(); openPropertyDetails(property.id)">Read More</a>
                        </p>
                      </div>
                      
                      <!-- Tags -->
                      <div class="property-tags mb-3 d-flex flex-wrap gap-2">
                        <span class="badge bg-light text-dark border" *ngFor="let tag of getAmenityTags(property)">{{ tag }}</span>
                      </div>
                      
                      
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

      <div class="d-flex justify-content-center align-items-center gap-2 mt-4" *ngIf="!loading && !loadError && filteredProperties.length > 0">
        <button class="btn btn-outline-primary btn-sm" (click)="previousPage()" [disabled]="currentPage === 1 || loadingMore">Previous</button>

        <button
          type="button"
          class="btn btn-sm"
          *ngFor="let page of getPaginationPages()"
          [class.btn-primary]="page === currentPage"
          [class.btn-outline-primary]="page !== currentPage"
          (click)="goToPage(page)"
          [disabled]="loadingMore"
        >
          {{ page }}
        </button>

        <button class="btn btn-outline-primary btn-sm" (click)="nextPage()" [disabled]="loadingMore || (!hasMoreProperties && currentPage >= totalPages)">
          Next
        </button>
      </div>
    </div>
  